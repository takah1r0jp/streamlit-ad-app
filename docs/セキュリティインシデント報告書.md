# 🚨 重大セキュリティインシデント報告書

**日時**: 2025年9月22日
**重要度**: 重大
**状況**: 緊急対応完了 - サービス停止済み

## インシデント概要

Streamlitアプリケーションにおける**重大なマルチテナント分離障害**により、全ユーザーのデータが共有される状態が発生。

## 影響を受けたシステム

- **サービス**: streamlit-ad-app (Cloud Run)
- **URL**: https://streamlit-ad-app-93993233888.asia-northeast1.run.app (削除済み)
- **期間**: 開始時期不明 - 2025年9月22日 17:XX JST (サービス削除)

## 発見された重大な脆弱性

### 1. APIキーの相互汚染 (重大)
```python
# app/main.py:181 - グローバル環境変数
os.environ["ANTHROPIC_API_KEY"] = new_api_key
```
- **リスク**: 全ユーザーが同じAPIキー環境変数を共有
- **影響**: ユーザーAのAPIキーがユーザーBからアクセス可能
- **漏洩対象**: Anthropic API認証情報

### 2. ファイルシステム共有 (高)
```python
# app/main.py:212 - 共有一時ディレクトリ
st.session_state.uploaded_image_path = temp_file_path
```
- **リスク**: アップロードされた画像がユーザーセッション間で共有
- **影響**: 機密画像が他ユーザーから閲覧可能

### 3. 生成コード共有 (高)
```python
# 適切な分離のないグローバルセッション状態
st.session_state.generated_code = generate_anomaly_detection_code(...)
```
- **リスク**: 独自の異常検知アルゴリズムが漏洩
- **影響**: ビジネスロジックと知的財産の盗難

### 4. 実行結果漏洩 (中)
- **リスク**: 検知結果が他ユーザーから閲覧可能
- **影響**: 機密の分析結果が漏洩

## 実施した緊急対応

1. **17:XX JST** - Cloud Runサービス `streamlit-ad-app` を削除
2. **17:XX JST** - 全デプロイワークフローを無効化
3. **17:XX JST** - Gitリポジトリをデプロイブロックで保護

## 技術的根本原因

**Streamlitマルチテナンシーの根本的誤解**:
- `os.environ`変数はセッションスコープではなく**プロセスグローバル**
- 適切なユーザー分離のないファイルパス
- 認証やセッション境界の強制なし

## データ漏洩評価

**潜在的漏洩対象**:
- ✅ APIキー (Anthropic)
- ✅ アップロード画像 (機密文書/写真)
- ✅ 生成コード (独自アルゴリズム)
- ✅ 検知結果 (ビジネスデータ)

**影響範囲**:
- 同時にサービスにアクセスした全ユーザー
- 同時セッション間での相互汚染
- 誰が何にアクセスしたかの監査証跡なし

## 必要な修復対応

### 即座の対応 (再デプロイ阻止要件)
1. **セッション分離**: 適切なユーザーセッション境界の実装
2. **APIキーセキュリティ**: グローバル環境変数使用の除去
3. **ファイル分離**: ユーザー固有の一時ディレクトリ
4. **認証**: ユーザー認証システムの追加

### 必要なコード変更
```python
# 変更前 (脆弱)
os.environ["ANTHROPIC_API_KEY"] = api_key

# 変更後 (安全)
# セッションスコープの安全なストレージにのみ保存
# グローバル環境変数には絶対に保存しない
```

## コンプライアンス影響

- **GDPR**: 潜在的違反 (同意なしのデータ共有)
- **プライバシー法**: ユーザー間データ漏洩
- **API利用規約**: Anthropic APIキー共有の潜在的違反

## 教訓

1. **ユーザー固有の秘密情報に`os.environ`を使用してはいけない**
2. **Streamlitの`session_state` ≠ 真のマルチテナント分離**
3. **ファイルシステム操作にはユーザースコープディレクトリが必要**
4. **本番デプロイ前にセキュリティレビューが必須**

## 次のステップ

1. **完全なセキュリティ監査まで再デプロイ禁止**
2. 適切なセッション分離アーキテクチャの実装
3. 包括的セキュリティテストの追加
4. 適切なマルチテナントフレームワークへの移行検討

---

**報告書作成**: 2025年9月22日 17:XX JST
**インシデント対応**: 完了 - サービス停止中
**状況**: セキュリティ修復待ち